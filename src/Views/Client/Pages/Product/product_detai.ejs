<%- include("../../Layouts/header") %>

<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-md-6">
            <img src="/client/images/<%= product.images %>" alt="<%= product.title %>" width="100%">
        </div>

        <div class="col-md-6">
            <h1 class="product-title" style="margin-top: 30px"><%= product.title %></h1>
            <p class="product-description"><strong><i>Mô tả: </i></strong><%= product.shortDescription %></p>
            <p class="product-description"><strong><i>Tác giả: </i></strong><%= product.author %></p>
            <p class="product-description"><strong><i>Nhà xuất bản: </i></strong><%= product.publisher %></p>

            <h6 style="font-weight: bolder;">Giá tiền: 
                <b style="color: red;"><%= product.price.toLocaleString('vi-VN') %> VND</b>
            </h6>
            <form action="/cart/add" method="post">
                <input type="hidden" name="product_id" value="<%= product.productId %>" required>
                <button type="submit" class="btn btn-sm add-to-cart">Thêm vào giỏ hàng</button>
            </form>
            
        </div>

        <br>

        <div class="product-detail bg-light p-4 mb-4">
            <h2 style="font-weight: bolder;">Chi tiết sản phẩm:</h2>
            <pre class="prev"><%- product.description %></pre>
        </div>

        <div class="d-flex align-items-center my-3">
            <div class="flex-grow-1 border-top border-dark"></div>
            <div class="mx-3 fs-4 text-secondary">✥</div>
            <div class="flex-grow-1 border-top border-dark"></div>
        </div>

        <div class="rating-section">
            <h3 class="mb-4 fw-bold">Đánh giá sản phẩm (<%= totalRatings %> người đã đánh giá)</h3>
        
            <form action="/product/<%= product.productId %>/rate" method="post" id="ratingForm">
                <div class="form-group">
                    <label for="rating">Chọn số sao bạn muốn đánh giá cho sản phẩm:</label>
                    <div class="star-rating d-flex">
                        <button type="button" class="btn btn-outline-warning" style="font-size: 30px; border: none; background-color: transparent; cursor: pointer;" data-value="1">&#9733;</button>
                        <button type="button" class="btn btn-outline-warning" style="font-size: 30px; border: none; background-color: transparent; cursor: pointer;" data-value="2">&#9733;</button>
                        <button type="button" class="btn btn-outline-warning" style="font-size: 30px; border: none; background-color: transparent; cursor: pointer;" data-value="3">&#9733;</button>
                        <button type="button" class="btn btn-outline-warning" style="font-size: 30px; border: none; background-color: transparent; cursor: pointer;" data-value="4">&#9733;</button>
                        <button type="button" class="btn btn-outline-warning" style="font-size: 30px; border: none; background-color: transparent; cursor: pointer;" data-value="5">&#9733;</button>
                    </div>
                    <input type="hidden" name="rating" id="rating" required />
                </div>
                <button type="submit" class="btn btn-primary mt-2">Gửi đánh giá</button>
            </form>
            
            <div class="mt-4">
                <h4>Đánh giá trung bình: 
                        <span class="text-warning"><%= averageRating %> ⭐</span>
                </h4>
                
                <% ratings.forEach(rating => { %>
                    <div class="card mb-3">
                        <div class="card-body">
                            <strong><%= rating.userName %></strong> đã đánh giá: 
                            <% for (let i = 1; i <= rating.rating; i++) { %>
                                <span class="text-warning">⭐</span>
                            <% } %>
                            <p><i class="text-muted">Được đăng lúc: <%= rating.createdAt %></i></p>
                        </div>
                    </div>
                <% }) %>                
            </div>
        </div>
        
        <div class="d-flex align-items-center my-3">
            <div class="flex-grow-1 border-top border-dark"></div>
            <div class="mx-3 fs-4 text-secondary">✥</div>
            <div class="flex-grow-1 border-top border-dark"></div>
        </div>

        <div class="comments-section">
            <h3 class="mb-4 fw-bold">Bình luận</h3>

            <form action="/product/<%= product.productId %>/comment" method="post">
                <div class="form-group">
                    <textarea name="comment" class="form-control" placeholder="Viết bình luận..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Gửi bình luận</button>
            </form>

            <div class="mt-4">
                <% comments.forEach(comment => { %>
                    <div class="card mb-3">
                        <div class="card-body">
                            <strong><%= comment.userName %></strong>
                            <p><%= comment.content %></p>
                            <p><i class="text-muted">Được đăng lúc: <%= comment.createdAt %></i></p>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const stars = document.querySelectorAll('.star-rating button');
    const ratingInput = document.getElementById('rating');

    stars.forEach(star => {
        star.addEventListener('click', (event) => {
            const ratingValue = event.target.getAttribute('data-value');

            stars.forEach(s => s.classList.remove('selected'));
            event.target.classList.add('selected');

            ratingInput.value = ratingValue;
        });

        star.addEventListener('mouseover', (event) => {
            const ratingValue = event.target.getAttribute('data-value');

            stars.forEach((s, index) => {
                if (index < ratingValue) {
                    s.style.color = 'gold';
                } else {
                    s.style.color = '#ddd';
                }
            });
        });

        star.addEventListener('mouseout', () => {
            stars.forEach(s => {
                if (!s.classList.contains('selected')) {
                    s.style.color = '#ddd';
                }
            });
        });
    });
});

const uniqueRatings = new Set(ratings.map(rating => rating.userId)).size;


</script>
<%- include("../../Layouts/footer") %>
